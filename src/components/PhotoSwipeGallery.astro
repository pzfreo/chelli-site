---
import 'photoswipe/dist/photoswipe.css';

interface Props {
  images: string[];
  title: string;
  id?: string;
}

const { images, title, id = 'gallery' } = Astro.props;
const galleryId = `pswp-${id}`;
---

<div class="pswp-gallery grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id={galleryId} data-pswp-gallery>
  {images.map((image, index) => (
    <a
      href={image}
      data-pswp-width="1200"
      data-pswp-height="1600"
      target="_blank"
      class="block aspect-[3/4] overflow-hidden bg-gray-100 cursor-zoom-in"
    >
      <img
        src={image}
        alt={`${title} - Image ${index + 1}`}
        class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
        loading={index < 4 ? 'eager' : 'lazy'}
      />
    </a>
  ))}
</div>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import PhotoSwipe from 'photoswipe';

  // Initialize PhotoSwipe for all galleries on the page
  document.querySelectorAll('[data-pswp-gallery]').forEach((gallery) => {
    const lightbox = new PhotoSwipeLightbox({
      gallery: gallery as HTMLElement,
      children: 'a',
      pswpModule: PhotoSwipe,
      bgOpacity: 0.95,
      padding: { top: 40, bottom: 40, left: 20, right: 20 },
    });

    // Dynamically get image dimensions once loaded
    lightbox.on('contentLoad', (e) => {
      const { content } = e;
      if (content.type === 'image') {
        const img = content.element as HTMLImageElement;
        if (img && img.complete && img.naturalWidth) {
          content.width = img.naturalWidth;
          content.height = img.naturalHeight;
        } else if (img) {
          img.onload = () => {
            content.width = img.naturalWidth;
            content.height = img.naturalHeight;
            content.instance?.updateSize(true);
          };
        }
      }
    });

    lightbox.on('uiRegister', function() {
      lightbox.pswp?.ui?.registerElement({
        name: 'counter',
        order: 5,
        isButton: false,
        appendTo: 'bar',
        onInit: (el, pswp) => {
          pswp.on('change', () => {
            el.textContent = `${pswp.currIndex + 1} / ${pswp.getNumItems()}`;
          });
        }
      });
    });

    lightbox.init();
  });
</script>
