---
import 'photoswipe/dist/photoswipe.css';

interface Props {
  images: string[];
  title: string;
  id?: string;
}

const { images, title, id = 'gallery' } = Astro.props;
const galleryId = `pswp-${id}`;
---

<div class="pswp-gallery grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id={galleryId} data-pswp-gallery>
  {images.map((image, index) => (
    <a
      href={image}
      target="_blank"
      class="block aspect-[3/4] overflow-hidden bg-gray-100 cursor-zoom-in"
    >
      <img
        src={image}
        alt={`${title} - Image ${index + 1}`}
        class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
        loading={index < 4 ? 'eager' : 'lazy'}
      />
    </a>
  ))}
</div>

<script>
  import PhotoSwipeLightbox from 'photoswipe/lightbox';
  import PhotoSwipe from 'photoswipe';

  // Initialize PhotoSwipe for all galleries on the page
  document.querySelectorAll('[data-pswp-gallery]').forEach((gallery) => {
    const lightbox = new PhotoSwipeLightbox({
      gallery: gallery as HTMLElement,
      children: 'a',
      pswpModule: PhotoSwipe,
      bgOpacity: 0.95,
      padding: { top: 40, bottom: 40, left: 20, right: 20 },
    });

    // Get actual image dimensions from thumbnail (same src = same dimensions)
    lightbox.addFilter('itemData', (itemData, index) => {
      const linkEl = gallery.querySelectorAll('a')[index];
      const imgEl = linkEl?.querySelector('img');

      // Use thumbnail's natural dimensions (already loaded)
      if (imgEl && imgEl.naturalWidth && imgEl.naturalHeight) {
        return {
          ...itemData,
          width: imgEl.naturalWidth,
          height: imgEl.naturalHeight,
        };
      }

      // Fallback: load image to get dimensions
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => {
          resolve({
            ...itemData,
            width: img.naturalWidth,
            height: img.naturalHeight,
          });
        };
        img.onerror = () => {
          resolve({ ...itemData, width: 1200, height: 1600 });
        };
        img.src = itemData.src as string;
      });
    });

    lightbox.on('uiRegister', function() {
      lightbox.pswp?.ui?.registerElement({
        name: 'counter',
        order: 5,
        isButton: false,
        appendTo: 'bar',
        onInit: (el, pswp) => {
          pswp.on('change', () => {
            el.textContent = `${pswp.currIndex + 1} / ${pswp.getNumItems()}`;
          });
        }
      });
    });

    lightbox.init();
  });
</script>
